var Constant={SECTION_NAV_TOOLTIPS:(function(){return["首页","搜索","定位","展示","探测","用户"]}()),SECTIONS_BG_COLOR:(function(){return["transparent","transparent","transparent","transparent","transparent","transparent"]}()),FIXED_ELEMENTS:(function(){return"#header, #footer, #sidebar,#header2, #global_search_wrapper, #tool_wrapper, #advs_wrapper, #search_tips"}()),SLIDE_NAV_TOOLTIPS:(function(){return["备用"]}()),NO_SEARCH_SECTION_IDX:(function(){return[0,1,4,5,6]}()),HOT_TERMS_URL:(function(){return"search/getHotTerms"}()),ADVS_SEARCH_RUL:(function(){return"api/advancedSearch"}()),LIST_SEARCH_URL:(function(){return"search/list"}()),LIST_SEARCH_2_URL:(function(){return"search/list2"}()),LIST_PJAX_SEARCH_URL:(function(){return"search/pjax/list"}()),LINE_SEARCH_URL:(function(){return"search/link"}()),MAP_SEARCH_URL:(function(){return"search/map"}()),MAP_IMG_BASEPATH:(function(){return"resources/img/"}()),BASEMAP_URL:(function(){return"http://10.10.2.81:6080/arcgis/rest/services/China_Community_BaseMap/MapServer"}()),CITY_FEATURELAYER_URL:(function(){return"http://10.10.2.81:6080/arcgis/rest/services/area/MapServer/1"}()),COUNTRY_FEATURESET_URL:(function(){return"api/getCountryFeatureSet"}()),PROVINCE_FEATURESET_URL:(function(){return"api/getProvinceFeatureSet"}()),USER_REGISTER_URL:(function(){return"user/register"}()),USER_LOGIN_URL:(function(){return"user/login"}()),USER_PWD_RETRIEVE_URL:(function(){return"http://10.10.2.174:8080/wum/login/forgetpwd.json"}()),SUGGEST_URL:(function(){return"search/getSuggestions?search="}()),RECOMMEND_URL:(function(){return"search/recommend"}()),LOCAL_SUGGEST_URL:(function(){return"resources/data/suggestions.json"}()),PAGE_SIZE:(function(){return 10}()),VISIBLE_PAGES:(function(){return 7}()),HIDE_SHOW_SPEED:(function(){return 500}()),KEY_MAPPING:(function(){return'{"type:":"device_type:","brand:":"device_brand:","service:":"device_service:","vul:":"vul_type:"}'}())};var currentPage=1;var marklineLoaded=false;var onMarklineLoad=function(){marklineLoaded=true};var initFullpage=function(){var addTooltip4Slides=function(slideNavTipList){var slideNavList=$(".fp-slidesNav a");$.each(slideNavTipList,function(idx,tip){$(slideNavList[idx]).attr({"data-toggle":"tooltip","title":tip})});slideNavList.tooltip()};var toggleFixedElement=function(sectionIdx){var hideIdxList=Constant.NO_SEARCH_SECTION_IDX;if($.inArray(sectionIdx,hideIdxList)>-1){if(!GlobalSearch.isHidden()){GlobalSearch.hide()}if(!Sidebar.isHidden()){Sidebar.hide();SearchTip.hide()}if(!Pivot.isHidden()){Pivot.hide()}if(!ResultOverview.isHidden()){ResultOverview.hide()}}else{if(GlobalSearch.isHidden()){GlobalSearch.show()}if(Sidebar.isHidden()){Sidebar.show();SearchTip.show()}if(Pivot.isHidden()){Pivot.show()}if(ResultOverview.isHidden()){ResultOverview.show()}}if(sectionIdx==3){$("#tool_wrapper").show()}else{$("#tool_wrapper").hide()}$.fn.fullpage.reBuild()};$(".fullpage").fullpage({menu:"#menu",navigation:true,navigationPosition:"right",navigationTooltips:Constant.SECTION_NAV_TOOLTIPS,animateAnchor:false,keyboardScrolling:false,controlArrows:false,sectionsColor:Constant.SECTIONS_BG_COLOR,fixedElements:Constant.FIXED_ELEMENTS,resize:true,paddingTop:"4.8rem",paddingBottom:"2.8rem",autoScrolling:true,normalScrollElements:"#mapHolder,#list_wrapper,#sidebar,.advs-wrapper,#search_tips",normalScrollElementTouchThreshold:3,scrollOverflow:true,afterRender:function(){$.fn.fullpage.reBuild()},afterResize:function(){$.fn.fullpage.reBuild()},onLeave:function(index,nextIndex,direction){switch(index){case 3:ArcMap.onLeave();break;case 5:iLine.window.destroy();clearTimeout(iLine.window.timeout);break;default:break}},afterLoad:function(anchorLink,index){toggleFixedElement(index);currentPage=index;var data=Session.get("data");switch(index){case 1:break;case 2:List.onLoad();if(data){GlobalSearch.setValue(JSON.parse(data["q"])["wd"]);List.onSearchSucceed(data)}UserSearchHistory.init();break;case 3:ArcMap.onLoad();if(data){GlobalSearch.setValue(JSON.parse(data["q"])["wd"]);ArcMap.onSearchSucceed(data)}UserSearchHistory.init();break;case 4:Sidebar.hide();break;case 5:Sidebar.hide();var lineInterval=setInterval(function(){if(marklineLoaded){iLine.window.starts();clearInterval(lineInterval)}},500);case 6:break}$.fn.fullpage.reBuild()},afterSlideLoad:function(anchorLink,index,slideAnchor,slideIndex){},onSlideLeave:function(anchorLink,index,slideIndex,direction,nextSlideIndex){}})};$(function(){Pace.ignore(function(){ArcMap.initFeatureSets();ArcMap.init()});InputSuggest.init();SearchTip.init();HomeSearch.listen();GlobalSearch.listen();AdvSearch.listen();User.listenerStarts();initFullpage()});var List={_WRAPPER_SEL:(function(){return".list-wrapper"}()),_RESULT_LIST_SEL:(function(){return".result-container ul.devices"}()),listPageNum:1,render:function(data){var genDeviceLi=function(d){var li=$(' <li class="device"></li>');var ip=$('<a href="http://'+d.ip+'" target="_blank">'+d.ip+"</a>");$("<h3></h3>").append(ip).appendTo(li);var row=$('<div class="row"></div>').appendTo(li);
    var facets=$(' <div class="col-md-3 col-sm-4 left"></div>').appendTo(row);if(d.hasOwnProperty("tags")&&d.tags!=""&&d.tags.length>0){var $tags=$('<div class="tag"></div>').appendTo(facets);d.tags.forEach(function(tag){$('<span class="label label-default"><a href="#'+tag+'"> '+tag+" </a></span>").appendTo($tags)})}var loc=d.location;if(loc&&loc!=""){var $location=$('<div class="tag location"></div>').appendTo(facets);$('<span class="label label-danger"><a href="#'+loc+'">'+'<span class="fa fa-map-marker"></span> '+loc+" </a></span>").appendTo($location)}facets.find("a").on("click",function(e){e.preventDefault()});var info=$('<div class="col-md-8 col-sm-7 right"></div>').appendTo(row);var ports=d["ports"],vuls=d["vuls"];if(ports.length>0||vuls.length>0){for(var i=0;i<ports.length;i++){if(ports[i]==""||ports[i]==null){continue}for(var pKey in ports[i]){var url=pKey.split(":")[0]+"://"+d.ip+":"+pKey.split(":")[1];var $port=$('<article><h3><a href="'+url+'" target="_blank"">'+pKey+"</a></article>").appendTo(info);var banner=ports[i][pKey];if(banner!="null"){banner=banner.replace(/</g,"&lt;")}var $pre=$("<pre>"+banner+"</pre>").appendTo($port);$pre.on("click",function(){if(!info.hasClass("active")){$(this).closest("div.right").addClass("active")}})}}for(var j=0;j<vuls.length;j++){if(!vuls[j]||vuls[j]==""){continue}$("<hr>").appendTo(info);for(var vKey in vuls[j]){var $vul=$('<article><h3><a href="#">'+vKey+"</a></article>").appendTo(info);$("<pre>"+JSON.stringify(vuls[j][vKey]["desc"])+"</pre>").appendTo($vul)}}}else{info.html("null")}var closeBtn=$('<button class="up"><span class="fa fa-caret-down"></span></button>').appendTo(info);closeBtn.on("click",function(){$(this).closest("div.right").toggleClass("active")});return li};var currpage=data["currpage"],total=data["total"],pagesize=data["pagesize"],took=data["took"],devices=data["data"];var $resultList=$(this._RESULT_LIST_SEL).html("");$(this._WRAPPER_SEL).show();ResultOverview.set(data);for(var i=0;i<devices.length;i++){$resultList.append(genDeviceLi(devices[i]))}paginator(total,pagesize,currpage,Constant.VISIBLE_PAGES,List.search);$(this._WRAPPER_SEL).scrollTop(0);$("#listSe").scrollTop(0)},search:function(pageNum){var wd=GlobalSearch.getValue();if(!wd&&wd==""){return}var successCallback=this.onSearchSucceed;var requestObj={"url":Constant.LIST_SEARCH_2_URL,"data":{"wd":wd,"filter":Pivot.getFilterByPivots2(),"page":1},"success":successCallback,"error":errorHandler};LoadData.post(requestObj)},onSearchSucceed:function(data){var statuscode=data["statuscode"];Session.set("data",data);ResultOverview.set(data);if(statuscode==200){Sidebar.render(data);List.render(data);$(List._WRAPPER_SEL).animate({scrollTop:0},"slow");$(".no-data").hide()}else{if(statuscode==204){console.log("list no data");noDataHandler(data)}else{console.log("list error");errorHandler()}}},onLoad:function(){$(Sidebar._WRAPPER_SEL).addClass("list");var data=Session.get("data"),wd=Session.get("wd");if(data&&wd){GlobalSearch.setValue(wd);HomeSearch.setValue(wd);this.onSearchSucceed(data)}}};var User={setNavUsername:function(name){var $usermenus=$("#menu").find('li[data-menuanchor="se6"]');var $logout=$("#logout");$usermenus.find("a").hide();$logout.on("click",function(e){e.preventDefault();Session.reset("username");$usermenus.find('a[href="#se6/se6_login"]').show();$logout.hide().find("span").text("")}).show().css("display","inline-block").find("span").text(name)},register:function(){var pswStr=$("#psw").val(),pswSha1Str=$.sha1(pswStr),formInfoList=[],user={},requestObj={};var successCallback=function(data){if(data.code==1){$.Showmsg("注册成功！即将返回到注册前的页面。");setTimeout(function(){var uname=data["data"]["username"];$.Hidemsg();Session.set("username",uname);User.setNavUsername(uname);history.back()},3000)}else{if(data.reason){$.showmsg("注册失败！"+data.reason);setTimeout(function(){$.Hidemsg()},2000)}else{errorCallback()}}};var errorCallback=function(){$.showmsg("注册失败，请稍后再试！");setTimeout(function(){$.Hidemsg()},2000)};$("#register_form").Validform({tiptype:3,beforeSubmit:function(curform){formInfoList=curform.serializeArray();for(var i=0;i<formInfoList.length;i++){var item=formInfoList[i];if(item.name=="password2"){continue}if(item.name=="password"){user[item.name]=pswSha1Str}else{user[item.name]=item.value}}requestObj={url:Constant.USER_REGISTER_URL,data:user,success:successCallback,error:errorCallback};LoadData.post(requestObj);return false}})},login:function(){var pswStr=$("#psw").val(),pswSha1Str=$.sha1(pswStr),formInfoList=[],user={},requestObj={};var successCallback=function(data){console.log(data);if(data.code==1){$.Showmsg("登录成功");setTimeout(function(){var uname=data["data"]["username"];$.Hidemsg();Session.set("username",uname);User.setNavUsername(uname);window.location.href=getRootPath()},2000)}else{if(data.reason){$.Showmsg("登录失败！"+data.reason);setTimeout(function(){$.Hidemsg()},2000)}else{errorCallback()}}};var errorCallback=function(){$.Showmsg("登录失败，请稍后再试！");setTimeout(function(){$.Hidemsg()},2000)};
    $("#login_form").Validform({tiptype:3,label:".label",showAllError:true,beforeSubmit:function(curform){formInfoList=curform.serializeArray();for(var i=0;i<formInfoList.length;i++){var item=formInfoList[i];if(item.name=="password"){user[item.name]=pswSha1Str}else{user[item.name]=item.value}}requestObj={url:Constant.USER_LOGIN_URL,success:successCallback,data:user,error:errorCallback};LoadData.post(requestObj);return false}})},pwdRetrieve:function(){var requestObj={};var successCallback=function(data){console.log(data);if(data.code==1){$.Showmsg("邮件发送成功!");setTimeout(function(){$.Hidemsg();window.location.href=getRootPath()+"#se6/se6_pwd"},3000)}else{if(data.reason){console.log("code != 1");$.Showmsg("操作失败!"+data.reason);setTimeout(function(){$.Hidemsg()},3000)}else{errorCallback()}}};var errorCallback=function(){$.Showmsg("操作失败，请稍后再试!");setTimeout(function(){$.Hidemsg()},3000)};$("#user_pwd_retrieve").Validform({tiptype:3,label:".label",showAllError:true,postonce:true,beforeSubmit:function(curform){requestObj={url:Constant.USER_PWD_RETRIEVE_URL+"?email="+$("#pwdRe_email").val(),success:successCallback,error:errorCallback};LoadData.get(requestObj);return false}})},listenerStarts:function(){var username=Session.get("username");if(username&&username!=""&&username!="undefined"){this.setNavUsername(username)}$(".wraper a").on("click",function(e){e.preventDefault();var hrefList=$(this).attr("href").split("/"),length=hrefList.length;if(length>=2){var section=hrefList[0].replace("#","");var slide=hrefList[1];$.fn.fullpage.silentMoveTo(section,slide)}});this.register();this.login();this.pwdRetrieve()}};var UserSearchHistory={_WRAPPER_SEL:(function(){return"#widget-search-history"}()),addItem:function(item){if(!item||item==null||item==""){return}var searchHistory=localStorage.getItem("searchHistory"),newHistory=[];if(searchHistory!=null&&searchHistory!="undefined"){$.each(JSON.parse(searchHistory),function(idx,value){if(item!=value){newHistory.push(value)}})}else{$(this._WRAPPER_SEL).show(Constant.HIDE_SHOW_SPEED)}newHistory.push(item);localStorage.setItem("searchHistory",JSON.stringify(newHistory));this.generateDoms(newHistory)},deleteItem:function(item){if(!item||item==null||item==""){return}var searchHistory=localStorage.getItem("searchHistory"),newHistory=[];if(searchHistory!=null&&searchHistory!="undefined"){$.each(JSON.parse(searchHistory),function(idx,value){if(item!=value){newHistory.push(value)}})}if(newHistory.length>0){localStorage.setItem("searchHistory",JSON.stringify(newHistory));this.generateDoms(newHistory)}else{localStorage.removeItem("searchHistory");$(this._WRAPPER_SEL).hide()}},generateDoms:function(searchHistory){if(searchHistory){var $history=$(".search-history-list").html(""),length=searchHistory.length;for(var i=0;i<length&&i<10;i++){var wd=searchHistory.pop();var hLi=$("<li></li>").hover(function(){$(this).addClass("hover")},function(){$(this).removeClass("hover")});var span=$('<span class="search-item">'+wd+"</span>").attr({"data-search-keyword":wd,"title":wd}).appendTo(hLi).on("click",function(e){e.preventDefault();$(this).closest("li").addClass("active");SearchTip.onClick(this)});var removeBtn=$('<button class="btn" data-toggle="confirmation">&times;</button>').appendTo(hLi).attr({"data-search-keyword":wd,"title":"确定要删除【" + wd + "】吗？"});$history.append(hLi)}$('[data-toggle="confirmation"]').confirmation({"btnOkIcon":"","btnCancelIcon":"","btnOkClass":"btn btn-sm btn-primary mr10","btnOkLabel":"确定","btnCancelLabel":"取消","placement":"bottom","onConfirm":function(event,element){event.preventDefault();UserSearchHistory.deleteItem(element.attr("data-search-keyword"))},"onCancel":function(event,element){element.closest("li").removeClass("active")}})}},init:function(){var searchHis=localStorage.getItem("searchHistory");if(searchHis&&searchHis!=null&&searchHis!="undefined"){this.generateDoms((JSON.parse(searchHis)))}else{$(this._WRAPPER_SEL).hide()}}};var Sidebar={_WRAPPER_SEL:(function(){return".sidebar"}()),show:function(){$(this._WRAPPER_SEL).show(Constant.HIDE_SHOW_SPEED)},hide:function(){$(this._WRAPPER_SEL).hide(Constant.HIDE_SHOW_SPEED)},isHidden:function(){return $(this._WRAPPER_SEL).is(":hidden")},render:function(data){var agg=data["aggregation"],wd=data["wd"]?data["wd"]:data["q"]["wd"];var genSidebarCountryLi=function(countryName,countryObj){var coLi=$('<li class="facet-value"></li>'),coInput=$('<input type="checkbox" class="country">').attr("value",countryName).css("display","none"),coLabelContainer=$('<div class="label-container"></div>'),coCount=$('<span class="facet-count"></span>').html("("+countryObj["count"]+")"),coLabel=$('<label class="facet-label"></label>').attr({"title":countryName}).append("<bdi>"+countryName+"</bdi>");var citiesContainer=$('<div class="collapse" data-country="'+countryName+'"></div>'),ciList=$('<ol class="inner-facet-values"></ol>');ciList.append(genSidebarLi("country",countryName,countryObj["count"]));$.each(countryObj["cities"],function(cityName,count){ciList.append(genSidebarLi("city",cityName,count))
});coLabelContainer.append(coCount).append(coLabel);citiesContainer.append(ciList);coLi.append(coInput).append(coLabelContainer).append(citiesContainer);coLabelContainer.on("click",function(){$(this).next().collapse("toggle")});return coLi};var genSidebarLi=function(key,value,count){var li=$('<li class="facet-value"></li>'),input=$('<input type="checkbox">').attr({"data-key":key,"data-value":value});if(key=="country"){value="全国"}else{if(value.toLocaleLowerCase()=="unknown"){input.attr({"disabled":"disabled"})}}var container=$('<div class="label-container"></div>'),countLabel=$('<span class="facet-count"></span>').html("("+count+")"),nameLabel=$('<label class="facet-label"></label>').attr({"title":value}).append("<bdi>"+value+"</bdi>");container.append(countLabel).append(nameLabel);li.append(input).append(container);input.on("click",function(){var $this=$(this),dKey=$this.attr("data-key"),dValue=$this.attr("data-value"),country=$this.attr("data-country");if(this.checked){if(country){Pivot.add(dKey,dValue,{"country":country})}else{Pivot.add(dKey,dValue)}}else{Pivot.remove({"dKey":dKey,"dValue":dValue,"country":country})}Sidebar.searchOnChange()});return li};$.each(agg,function(key,value){var id=key!="country@%city"?(key+"List"):"countryList";var $ol=$("#"+id).find("ol.facet-values").html("");if(!isEmptyObject(value)){}else{$ol.closest("div.panel").hide()}if(key=="country@%city"){if(!isEmptyObject(value)){$.each(value,function(countryName,countryObj){$ol.append(genSidebarCountryLi(countryName,countryObj))})}}else{if(!isEmptyObject(value)){$.each(value,function(name,count){$ol.append(genSidebarLi(key,name,count)).closest("div.panel").show()})}}});$("div.panel-collapse.collapse").removeClass("in");if(wd&&wd!=""){var wdList=wd.split(" ");for(var i=0;i<wdList.length;i++){var item=wdList[i];if(item.indexOf(":")>0){var dKey=item.split(":")[0],dValue=item.split(":")[1],$input=$(Sidebar._WRAPPER_SEL+' input[data-value="'+dValue+'"]'),value;if($input&&$input.attr("data-key")==dKey){value=$input.val();$input.prop("checked",true);if(dKey=="country"){var siblings=$input.closest("li").siblings("li");siblings.each(function(index,item){var i=$(item).find("input").prop("checked",true).attr("disabled","disabled");Pivot.remove({"dKye":dKey,"dValue":dValue})})}$input.closest("div.collapse").addClass("in");if(dKey=="city"||dKey=="country"){$("#countryList").addClass("in")}Pivot.add(dKey,dValue,value)}}}}$(".panel-title a").on("click",function(){var $this=$(this);if($this.attr("aria-expanded")=="false"){$this.find("span").addClass("glyphicon-menu-right").removeClass("glyphicon-menu-down")}else{$this.find("span").addClass("glyphicon-menu-down").removeClass("glyphicon-menu-right")}})},render2:function(data){var agg=data["aggregation"],wd=data["q"]["wd"],filter=data["q"]["filter"];var genSidebarCountryLi=function(countryName,countryObj){var coLi=$('<li class="facet-value"></li>'),coInput=$('<input type="checkbox" class="country">').attr("value",countryName).css("display","none"),coLabelContainer=$('<div class="label-container"></div>'),coCount=$('<span class="facet-count"></span>').html("("+countryObj["count"]+")"),coLabel=$('<label class="facet-label"></label>').attr({"title":countryName}).append("<bdi>"+countryName+"</bdi>");var citiesContainer=$('<div class="collapse" data-country="'+countryName+'"></div>'),ciList=$('<ol class="inner-facet-values"></ol>');ciList.append(genSidebarLi("country",countryName,countryObj["count"]));$.each(countryObj["cities"],function(cityName,count){ciList.append(genSidebarLi("city",cityName,count))});coLabelContainer.append(coCount).append(coLabel);citiesContainer.append(ciList);coLi.append(coInput).append(coLabelContainer).append(citiesContainer);coLabelContainer.on("click",function(){$(this).next().collapse("toggle")});return coLi};var genSidebarLi=function(key,value,count){var li=$('<li class="facet-value"></li>'),input=$('<input type="checkbox">').attr({"data-key":key,"data-value":value});if(key=="country"){value="全国"}else{if(value.toLocaleLowerCase()=="unknown"){input.attr({"disabled":"disabled"})}}var container=$('<div class="label-container"></div>'),countLabel=$('<span class="facet-count"></span>').html("("+count+")"),nameLabel=$('<label class="facet-label"></label>').attr({"title":value}).append("<bdi>"+value+"</bdi>");container.append(countLabel).append(nameLabel);li.append(input).append(container);input.on("click",function(){var $this=$(this),dKey=$this.attr("data-key"),dValue=$this.attr("data-value"),country=$this.attr("data-country");if(this.checked){if(country){Pivot.add(dKey,dValue,{"country":country})}else{Pivot.add(dKey,dValue)}}else{Pivot.remove({"dKey":dKey,"dValue":dValue,"country":country})}Sidebar.searchOnChange()});return li};$.each(agg,function(key,value){var id=key!="country@%city"?(key+"List"):"countryList";var $ol=$("#"+id).find("ol.facet-values").html("");if(!isEmptyObject(value)){}else{$ol.closest("div.panel").hide()}if(key=="country@%city"){if(!isEmptyObject(value)){$.each(value,function(countryName,countryObj){$ol.append(genSidebarCountryLi(countryName,countryObj))
})}}else{if(!isEmptyObject(value)){$.each(value,function(name,count){$ol.append(genSidebarLi(key,name,count)).closest("div.panel").show()})}}});$("div.panel-collapse.collapse").removeClass("in");if(filter&&!isEmptyObject(filter)){for(var key in filter){var filterItemList=filter[key];$.each(filterItemList,function(fIdx,value){var $input=$(Sidebar._WRAPPER_SEL+' input[data-value="'+value+'"][data-key="'+key+'"]');if($input){$input.prop("checked",true);if(key=="country"&&(!filter["city"]||filter["city"].length==0)){var siblings=$input.closest("li").siblings("li");$.each(siblings,function(sIdx,li){$(li).find("input").prop("checked",true).attr("disabled","disabled");Pivot.remove({"dKye":key,"dValue":value})})}}$input.closest("div.collapse").addClass("in");if(key=="city"||key=="country"){$("#countryList").addClass("in")}})}}$(".panel-title a").on("click",function(){var $this=$(this);if($this.attr("aria-expanded")=="false"){$this.find("span").addClass("glyphicon-menu-right").removeClass("glyphicon-menu-down")}else{$this.find("span").addClass("glyphicon-menu-down").removeClass("glyphicon-menu-right")}})},searchOnChange:function(){var currentPage=$(Sidebar._WRAPPER_SEL).attr("class");if(currentPage.indexOf("list")!=1){List.search(1)}else{if(currentPage.indexOf("map")!=-1){ArcMap.search(1)}}}};var Pivot={_WRAPPER_SEL:(function(){return".pivots-wrapper"}()),_PIVOTS_UL_SEL:(function(){return".pivots"}()),show:function(){$(this._WRAPPER_SEL).show(Constant.HIDE_SHOW_SPEED)},hide:function(){$(this._WRAPPER_SEL).hide()},isHidden:function(){return $(this._WRAPPER_SEL).is(":hidden")},init:function(){$(this._PIVOTS_UL_SEL).html("")},add:function(dKey,dValue,value,extra){var $pivots=$(this._PIVOTS_UL_SEL),$pivot=$pivots.find('li[data-value="'+dValue+'"]');if($pivot&&$pivot.attr("data-key")==dKey&&(!extra||$pivot.attr("data-country")==extra["country"])){return}var genPivot=function(dk,dv,e){var $pivot=$('<li class="pivot"></li>').attr({"data-key":dk,"data-value":dv}).html(dv);if(e&&e["country"]){$pivot.attr("data-country",e["country"])}var closeBtn=$('<button class="remove-pivot badge" type="submit">&times;</button>').appendTo($pivot);closeBtn.on("click",function(){$(this).parent("li.pivot").remove();Sidebar.searchOnChange()});return $pivot};$pivots.append(genPivot(dKey,dValue,value,extra));if($pivots.find("li").length>0){this.show()}},remove:function(data,pivot){if(pivot){pivot.remove()}else{var $p=$(this._PIVOTS_UL_SEL).find('li[data-value="'+data["dValue"]+'"]');if($p.attr("data-key")==data["dKey"]&&(!data["country"]||data["country"]==$p.attr("data-country"))){$p.remove()}}if($(this._PIVOTS_UL_SEL).find("li").length<=0){this.hide()}},getFilterByPivots:function(){var result="";$(this._PIVOTS_UL_SEL).find("li").each(function(idx,item){var $item=$(item);if($item.attr("data-country")){result+="country:"+$item.attr("data-country")+" "}result+=$item.attr("data-key")+":"+$item.attr("data-value")+" "});return result.trim()},getFilterByPivots2:function(){var filter={};$(this._PIVOTS_UL_SEL).find("li").each(function(idx,pivot){var $pivot=$(pivot),key=$pivot.attr("data-key"),value=$pivot.attr("data-value"),country=$pivot.attr("data-value");if(filter[key]){filter[key].push(value)}else{filter[key]=[value]}if(key=="city"&&country){if(filter["country"]){filter["country"].push(country)}else{filter["country"]=[country]}}});return filter}};var ResultOverview={_WRAPPER_SEL:(function(){return".result-overview"}()),show:function(){$(this._WRAPPER_SEL).fadeIn(Constant.HIDE_SHOW_SPEED)},hide:function(){$(this._WRAPPER_SEL).fadeOut(Constant.HIDE_SHOW_SPEED)},isHidden:function(){return $(this._WRAPPER_SEL).is(":hidden")},set:function(data){var currpage=data["currpage"],count=data["total"],pagesize=data["pagesize"],duration=data["took"];var overview=$(this._WRAPPER_SEL);overview.find("strong.count").text(count);overview.find("strong.duration").text(duration);overview.find("strong.page-num").text(currpage+" / "+(Math.floor(count/pagesize)+1))}};var SearchTip={_WRAPPER_SEL:(function(){return"#search_tips"}()),show:function(){$(this._WRAPPER_SEL).show(Constant.HIDE_SHOW_SPEED)},hide:function(){$(this._WRAPPER_SEL).hide(Constant.HIDE_SHOW_SPEED)},isHidden:function(){return $(this._WRAPPER_SEL).is(":hidden")},render:function(data){},listen:function(){$("#search_tips li").hover(function(){$(this).addClass("hover")},function(){$(this).removeClass("hover")});$(".search-item").on("click",function(e){e.preventDefault();var $this=$(this),wd=$this.attr("data-search-keyword");console.log(this);var successCallback;$this.closest("li").addClass("active");if($("#listSe").hasClass("active")){successCallback=List.onSearchSucceed}else{if($("#mapSe").hasClass("active")){successCallback=ArcMap.onSearchSucceed}}var requestObj={"url":Constant.LIST_SEARCH_2_URL,"data":{"wd":wd,"page":1},"success":successCallback};UserSearchHistory.addItem(wd);GlobalSearch.setValue(wd);HomeSearch.setValue(wd);LoadData.post(requestObj);if(currentPage==1){$.fn.fullpage.silentMoveTo(2)}})},onClick:function(element){var $this=$(element),wd=$this.attr("data-search-keyword");
    var successCallback;if(currentPage==2){successCallback=List.onSearchSucceed}else{if(currentPage==3){successCallback=ArcMap.onSearchSucceed}else{if(currentPage==1){successCallback=function(data){$.fn.fullpage.silentMoveTo("se2");List.onSearchSucceed(data)}}}}var requestObj={"url":Constant.LIST_SEARCH_2_URL,"data":{"wd":wd,"page":1},"success":successCallback};Pivot.init();UserSearchHistory.addItem(wd);GlobalSearch.setValue(wd);HomeSearch.setValue(wd);LoadData.post(requestObj)},init:function(){var popSearchList=$(".popular-search-list"),hisSearchList=$(".search-history-list");$.getJSON(Constant.HOT_TERMS_URL,{},function(data){for(var key in data["wd"]){var popularLi=$("<li></li>");var span=$('<span class="search-item">'+key+"</span>").attr({"data-search-keyword":key,"title":key}).appendTo(popularLi);popularLi.hover(function(){$(this).addClass("hover")},function(){$(this).removeClass("hover")});span.on("click",function(e){e.preventDefault();SearchTip.onClick(this)});popSearchList.append(popularLi)}});$(".sys-rec").find("li").hover(function(){$(this).addClass("hover")},function(){$(this).removeClass("hover")}).find("span").on("click",function(e){e.preventDefault();SearchTip.onClick(this)})}};var InputSuggest={init:function(){this.suggestCursorToggle();this.getSuggestions(".home-search-input",Constant.SUGGEST_URL);this.getSuggestions("#global_search_input",Constant.SUGGEST_URL);this.startRecommend()},getSuggestions:function(inputSelector,sourceURL){var $input=$(inputSelector);var $form=$input.closest("form");var suggestions=function(sourceURL){var bloodHound=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("value"),queryTokenizer:Bloodhound.tokenizers.whitespace,prefetch:{url:Constant.LOCAL_SUGGEST_URL,limit:10,filter:function(resp){if(resp[$input.attr("id")]){return $.map(resp[$input.attr("id")],function(item){return $.isArray(item)&&item.length==2?{title:item[0],desc:item[1],value:item[0]}:{title:item,value:item}})}else{var suggestions=[];for(var key in resp){suggestions=suggestions.concat(resp[key])}return $.map(suggestions,function(item){return $.isArray(item)&&item.length==2?{title:item[0],desc:item[1],value:item[0]}:{title:item,value:item}})}}},remote:{url:sourceURL+"%QUERY",filter:function(resp){return $.map(resp.data,function(item){return $.isArray(item)&&item.length==2?{title:item[0],desc:item[1],value:item[0]}:{title:item,value:item}})},wildcard:"%QUERY"}});bloodHound.initialize();return bloodHound.ttAdapter()};if($input.length){$input.typeahead({hint:false,highlight:true,minLength:1},{display:"value",source:suggestions(sourceURL),limit:10,templates:{suggestion:function(data){var result=data.title;if(data.desc){result+='<span class="muted pull-right">'+data.desc+"</span>"}return"<div>"+result+"</div>"}}}).on("typeahead:selected",function(event,suggestion){$form.submit()}).on("keypress keydown keyup paste change",function(evt){}).filter(".home-search .flex-text").focus()}},suggestCursorToggle:function(){$("body").on("mouseover",".tt-suggestion",function(){$(".tt-suggestion").removeClass("tt-cursor");$(this).addClass("tt-cursor")})},startRecommend:function(){var $input=$("input[role=combobox]");function recommendInput(){var url=Constant.RECOMMEND_URL;var dorks=[];var length=0;function randomInput(){var recommend="";var random=parseInt(Math.random()*length,10);if($input.val()==""){recommend=dorks[random];$input.attr("placeholder",recommend)}setTimeout(function(){randomInput()},3000)}$.getJSON(url,{},function(data){dorks=data.data;length=data.data.length;randomInput()})}if($input.length){setTimeout(function(){recommendInput()},300)}}};var GlobalSearch={_WRAPPER_SEL:(function(){return".global-search-wrapper"}()),_FORM_SEL:(function(){return".global-search-form"}()),_INPUT_SEL:(function(){return"#global_search_input"}()),setValue:function(val){$(this._INPUT_SEL).val(val)},getValue:function(){var $input=$(this._INPUT_SEL),val=$input.val();if(val==""){val=$input.attr("placeholder");$input.val(val)}return val},show:function(){$(this._WRAPPER_SEL).show(Constant.HIDE_SHOW_SPEED)},hide:function(){$(this._WRAPPER_SEL).hide(Constant.HIDE_SHOW_SPEED)},isHidden:function(){return $(this._WRAPPER_SEL).is(":hidden")},listen:function(){$(GlobalSearch._FORM_SEL).on("submit",function(e){e.preventDefault();var wd=GlobalSearch.getValue();$(".tt-menu").hide(300);if(wd==""){return}Pivot.init();HomeSearch.setValue(wd);UserSearchHistory.addItem(wd);if($("#listSe").hasClass("active")){List.search(1)}else{if($("#mapSe").hasClass("active")){ArcMap.search(1)}}})}};var Session={get:function(key){var value;switch(key){case"username":value=getUsername();break;case"wd":value=getWd();break;case"checked":value=getChecked();break;case"data":value=getData();break}if(!value||value=="undefined"||value==""){value=undefined}return value;function getUsername(){var uname=sessionStorage.getItem("username");if(uname){uname=uname.trim()}return uname}function getWd(){var wd=sessionStorage.getItem("wd");if(wd){wd=wd.trim()}return wd}function getChecked(){var checked=sessionStorage.getItem("checked");
    if(checked&&checked!="undefined"){checked=JSON.parse(checked)}return checked}function getData(){var data=sessionStorage.getItem("data");if(data&&data!="undefined"){data=JSON.parse(data)}return data}},set:function(key,value,operation){switch(key){case"wd":setWd(value);break;case"username":setUsername(value);break;case"checked":setChecked(value,operation);break;case"data":setData(value);break}function setWd(value){if(value){sessionStorage.setItem("wd",value)}}function setUsername(value){if(value&&value!=""){sessionStorage.setItem("username",value)}}function setChecked(value,operation){if(value==undefined||value=="undefined"||value==""){return}var checked=[];if(Session.get("checked")){checked=Session.get("checked")}switch(operation){case"add":checked.push(value);break;case"remove":checked.splice(jQuery.inArray(value,checked),1);break}if(checked.length===0){Session.reset("checked")}else{sessionStorage.setItem("checked",JSON.stringify(checked))}}function setData(value){if(value&&value!="undefined"){sessionStorage.setItem("data",JSON.stringify(value))}}},reset:function(key){sessionStorage.removeItem(key)}};var HomeSearch={_INPUT_SEL:(function(){return"#hsi"}()),_FORM_SEL:(function(){return"#home_search_form"}()),getValue:function(){var $input=$(this._INPUT_SEL),val=$input.val();if(val==""){val=$input.attr("placeholder");$input.val(val)}return val},setValue:function(val){$(this._INPUT_SEL).val(val)},listen:function(){var $form=$(this._FORM_SEL);$form.on("submit",function(e){e.preventDefault();var wd=HomeSearch.getValue();var successCallback=List.onSearchSucceed;var requestObj={"url":Constant.LIST_SEARCH_2_URL,"success":successCallback,"error":errorHandler,"data":{"wd":wd,"page":1}};Pivot.init();GlobalSearch.setValue(wd);UserSearchHistory.addItem(wd);$.fn.fullpage.silentMoveTo("se2");LoadData.post(requestObj)})}};var errorHandler=function(){$.Showmsg("服务器开小差啦，请稍后再试！");setTimeout(function(){$.Hidemsg()},3000)};var noDataHandler=function(data){if($("#listSe").hasClass("active")){$(List._WRAPPER_SEL).hide();$(".no-data").show()}$(".search-box-container").popover({content:"没有搜索到"+""+"相关的数据，可尝试搜索其他关键词",placement:"bottom",trigger:"manual"}).popover("show");setTimeout(function(){$(".search-box-container").popover("hide")},2000)};var ArcMap={_WRAPPER_SEL:(function(){return".map-wrapper"}()),v:{MAP_PAGE_SIZE:10,map:{},countryFS:{},provinceFS:{},cityFS:{},cityLayer:{},clusterLayer:{},featureLayer:{},labelLayer:{},data:{}},initFeatureSets:function(){var getFeatureSet=function(url,which){Pace.ignore(function(){$.ajax({url:url,type:"post",contentType:"application/json",dataType:"json",timeout:50000}).success(function(data){if(which=="country"){ArcMap.v.countryFS=data.data}else{if(which=="province"){ArcMap.v.provinceFS=data.data}else{if(which=="city"){ArcMap.v.cityFS=data.data}}}}).error(function(){console.log("Getting country feature set error!")}).fail(function(){console.log("Getting country feature set failed!")})})};getFeatureSet(Constant.COUNTRY_FEATURESET_URL,"country");getFeatureSet(Constant.PROVINCE_FEATURESET_URL,"province")},init:function(){require(["esri/map","esri/layers/ArcGISTiledMapServiceLayer","esri/layers/GraphicsLayer","esri/InfoTemplate","esri/layers/FeatureLayer","esri/symbols/SimpleLineSymbol","esri/symbols/SimpleFillSymbol","esri/Color","dojo/domReady!"],function(Map,ArcGISTiledMapServiceLayer,GraphicsLayer,InfoTemplate,FeatureLayer,SimpleLineSymbol,SimpleFillSymbol,Color,HomeButton){var map,featureLayer,labelLayer,cityLayer;map=new Map("mapHolder",{center:[114.25,24.1167],minZoom:3,maxZoom:8,zoom:4,sliderPosition:"top-right",logo:false});var basemap=new ArcGISTiledMapServiceLayer(Constant.BASEMAP_URL);map.addLayer(basemap);var featureLayerInfoTemplate=new InfoTemplate("${Name_CHN}","国家<b>${Name_CHN}<b><br>共发现目标：<b>${count}</b>个");var flOutline=new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID,new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,new Color([230,255,0]),2),new Color([121,37,135,0.7]));featureLayer=new GraphicsLayer(featureLayerInfoTemplate);featureLayer.on("click",function(evt){var attr=evt.graphic.attributes;var name=attr.Name_CHN?attr.Name_CHN:attr.NAME;$(".f-country").text(name);$(".f-count").text(attr.count)});featureLayer.on("mouse-over",function(evt){evt.graphic.setSymbol(flOutline)});featureLayer.on("mouse-out",function(evt){evt.graphic.setSymbol(null)});map.addLayer(featureLayer);labelLayer=new GraphicsLayer();map.addLayer(labelLayer);Pace.ignore(function(){ArcMap.v.cityLayer=new FeatureLayer(Constant.CITY_FEATURELAYER_URL,{outFields:["*"]})});map.on("load",function(){Pace.ignore(function(){ArcMap.v.cityLayer.setMaxAllowableOffset(map.extent.getWidth()/map.width)});ArcMap.v.map=map;ArcMap.v.featureLayer=featureLayer;ArcMap.v.labelLayer=labelLayer;$("#sidebarCtrl").on("click",function(e){e.preventDefault();var $this=$(this);$this.toggleClass("open");if($this.hasClass("open")){Sidebar.show();$this.html('<span class="fa fa-caret-left"></span>'+"隐藏侧栏")}else{Sidebar.hide();$this.html('<span class="fa fa-caret-right"></span>'+"显示侧栏")
}});$("#mapSidebarCtrl").on("click",function(e){e.preventDefault();var $this=$(this),mapSidebar=$("#mapSidebar");if(MapSidebar.isHidden()){MapSidebar.show();$this.html("隐藏数据"+'<span class="fa fa-caret-left"></span>')}else{MapSidebar.hide();$this.html("显示数据"+'<span class="fa fa-caret-right"></span>')}});$(".map-sidebar-link").on("click",function(e){e.preventDefault()}).on("hover",function(e){e.preventDefault();$("#mapSidebar").addClass("onHover")});$(".map-layer a").removeClass("disabled").on("click",function(e){e.preventDefault();var $this=$(this);$this.toggleClass("open");if($this.hasClass("open")){$(".map-layer a").removeClass("open").find("span").removeClass("fa fa-caret-right");$this.addClass("open").find("span").addClass("fa fa-caret-right");MyFeatureLayer.show($this.attr("id"),ArcMap.v)}else{MyFeatureLayer.hide();$this.removeClass("open").find("span").removeClass("fa fa-caret-right")}});$("#labelLayerCtrl").removeClass("disabled").on("click",function(e){e.preventDefault();var $this=$(this);if(!$this.hasClass("active")){ArcMap.v.labelLayer.show();$this.addClass("active").html("隐藏数量"+'<span class="fa fa-caret-right"></span>')}else{ArcMap.v.labelLayer.hide();$this.removeClass("active").html("显示数量"+'<span class="fa fa-caret-left"></span>')}})});map.on("zoom-end",function(e){if($("#city").hasClass("open")){MyFeatureLayer.updateCityLayer(ArcMap.v)}});map.on("pan-end",function(e){})})},onLoad:function(){$(Sidebar._WRAPPER_SEL).addClass("map");$(SearchTip._WRAPPER_SEL).addClass("map");$("#header2").addClass("map");var data=Session.get("data"),wd=Session.get("wd");if(data&&wd){GlobalSearch.setValue(wd);HomeSearch.setValue(wd);this.onSearchSucceed(data)}},onLeave:function(){$(Sidebar._WRAPPER_SEL).removeClass("map");$(SearchTip._WRAPPER_SEL).removeClass("map");$("#header2").removeClass("map")},render:function(data){var layerToShow=$(".map-layer").find("a.open"),whichFeature=layerToShow?layerToShow.attr("id"):"country",map=this.v.map;if(!isEmptyObject(map)){MyFeatureLayer.show(whichFeature,this.v,data);this.centerAt(this.v.map,this.v.data.data[0]);$("#featureInfo").find("strong").text("")}else{var interval=setInterval(function(){if(!isEmptyObject(map)){MyFeatureLayer.show(whichFeature,ArcMap.v,data);clearInterval(interval)}},1000)}},search:function(pageNum){var wd=GlobalSearch.getValue();if(!wd&&wd==""){return}var successCallback=this.onSearchSucceed;var requestObj={"url":Constant.MAP_SEARCH_URL,"success":successCallback,"error":errorHandler,"data":{"wd":wd+" "+Pivot.getFilterByPivots(),"pagesize":this.v.MAP_PAGE_SIZE,"page":pageNum?pageNum:1}};LoadData.post(requestObj);function getVisibleExtent(){var polygonCCW="";require(["esri/geometry/ScreenPoint","esri/geometry/webMercatorUtils"],function(ScreenPoint,webMercatorUtils){var map=ArcMap.v.map;var windowHeight=$(window).height(),windowWidth=$(window).width();var sLeftTop=new ScreenPoint(0,0),sRightBottom=new ScreenPoint(windowWidth,windowHeight);var mLeftTop=webMercatorUtils.webMercatorToGeographic(map.toMap(sLeftTop)),mRightBottom=webMercatorUtils.webMercatorToGeographic(map.toMap(sRightBottom));var xL=mLeftTop.x,xR=mRightBottom.x,yT=mLeftTop.y,yB=mRightBottom.y;polygonCCW="polygon("+xL+" "+yT+","+xL+" "+yB+","+xR+" "+yB+","+xR+" "+yT+","+xL+" "+yT+")"});return polygonCCW}},addClusterLayer:function(devices){var cleanUp=function(){map.infoWindow.hide();clusterLayer.clearSingles()};if(!devices){return}if(clusterLayer){map.removeLayer(clusterLayer);clusterLayer.clear()}require(["esri/SpatialReference","esri/dijit/PopupTemplate","esri/geometry/Point","esri/geometry/webMercatorUtils","extras/ClusterLayer","esri/symbols/SimpleLineSymbol","esri/symbols/SimpleMarkerSymbol","esri/symbols/PictureMarkerSymbol","esri/renderers/ClassBreaksRenderer","esri/symbols/SimpleFillSymbol"],function(SpatialReference,PopupTemplate,Point,webMercatorUtils,ClusterLayer,SimpleLineSymbol,SimpleMarkerSymbol,PictureMarkerSymbol,ClassBreaksRenderer){var devicesInfo={};var wgs=new SpatialReference({"wkid":4326});devicesInfo.data=$.map(devices,function(d){var latlng=new Point(parseFloat(d.lon),parseFloat(d.lat),wgs);var webMercator=webMercatorUtils.geographicToWebMercator(latlng);var ports=d.ports,vuls=d.vuls,portsStr="",vulsStr="",imgArr=[];for(var i=0;i<ports.length;i++){for(var p in ports[i]){portsStr+=p+" "}}for(var j=0;j<vuls.length;j++){for(var key in vuls[j]){vulsStr+=key+" ";if(vuls[j][key].hasOwnProperty("imgURL")&&vuls[j][key]["imgURL"]!=""){imgArr.push(vuls[j][key]["imgURL"])}}}var attributes={"IP":d.ip,"Location":d.location,"Ports":portsStr,"Tags":d.tags,"Vuls":vulsStr,"Timestamp":d.timestamp,"Image":imgArr[0]};return{"x":webMercator.x,"y":webMercator.y,"attributes":attributes}});var popupTemplate=new PopupTemplate({"title":"","fieldInfos":[{"fieldName":"IP",visible:true},{"fieldName":"Location","label":"位置",visible:true},{"fieldName":"Ports","label":"服务",visible:true},{"fieldName":"Vuls","label":"漏洞",visible:true},{"fieldName":"Tags","label":"标签",visible:true}],"mediaInfos":[{"title":"","caption":"","type":"image","value":{"sourceURL":"{Image}","linkURL":"{Image}"}}]});
    clusterLayer=new ClusterLayer({"data":devicesInfo.data,"distance":100,"id":"clusters","labelColor":"#fff","labelOffset":10,"resolution":map.extent.getWidth()/map.width,"singleColor":"#888","singleTemplate":popupTemplate});var defaultSym=new SimpleMarkerSymbol().setSize(4);var renderer=new ClassBreaksRenderer(defaultSym,"clusterCount");var green=new PictureMarkerSymbol(imgUrl+"green.png",64,64).setOffset(0,15);var red=new PictureMarkerSymbol(imgUrl+"red.png",72,72).setOffset(0,15);renderer.addBreak(0,200,green);renderer.addBreak(200,1001,red);clusterLayer.setRenderer(renderer);map.addLayer(clusterLayer);clusterLayer.redraw();var cp=new Point(devices[0].lon,devices[0].lat);map.centerAndZoom(cp,4);clusterLayer.on("click",function(e){e.preventDefault()});map.on("key-down",function(e){if(e.keyCode===27){cleanUp()}})})},onSearchSucceed:function(data){var statuscode=data["statuscode"];ArcMap.v.data=data;Session.set("data",data);ResultOverview.set(data);if(statuscode==200){Sidebar.render(data);ArcMap.render(data)}else{if(statuscode==204){noDataHandler(data)}else{errorHandler()}}},centerAt:function(map,device){require(["esri/geometry/Point"],function(Point){var cp=new Point(device.lon,device.lat);map.centerAndZoom(cp,4)})}};var MyFeatureLayer={featuresDisplayed:{},show:function(which,mapVar){var map=mapVar.map,featureLayer=mapVar.featureLayer,labelLayer=mapVar.labelLayer,countryFS=mapVar.countryFS,provinceFS=mapVar.provinceFS,cityLayer=mapVar.cityLayer,data=mapVar.data;Pace.start();if(!isEmptyObject(data)&&data["statuscode"]==200){$("#featureInfo").show();map.removeLayer(featureLayer);featureLayer.clear();map.removeLayer(labelLayer);labelLayer.clear();switch(which){case"country":showCountry(data["aggregation"]);break;case"province":showProvince(data["aggregation"]);break;case"city":showCityFromArcGis(data["aggregation"]);break}}else{noDataHandler(data)}Pace.stop();function showCountry(agg){if(!agg["country@%city"]||isEmptyObject(agg["country@%city"])){return}if(countryFS.features&&!isEmptyObject(countryFS.features)){render(agg["country@%city"],countryFS.features)}else{var wait=setInterval(function(){if(countryFS.features&&!isEmptyObject(countryFS.features)){render(agg["country@%city"],countryFS.features);clearInterval(wait)}},1000)}function render(countries,features){var min=Number.MAX_VALUE,max=0;require(["esri/graphic"],function(Graphic){for(var key in countries){var country=countries[key];if(country.en&&features.hasOwnProperty(country.en)){var g=features[country.en];g.attributes.count=country.count;g.attributes.Name_CHN=key;var newGraphic=new Graphic(g);featureLayer.add(newGraphic);MyFeatureLayer.addLabel(labelLayer,newGraphic,country.count);setMinMax(country.count)}}renderFeatureLayer(featureLayer,min,max)});function setMinMax(count){if(count<min){min=count}if(count>max){max=count}}}}function showProvince(agg){if(!agg["province"]||isEmptyObject(agg["province"])){return}if(provinceFS.features&&!isEmptyObject(provinceFS.features)){render(agg["province"],provinceFS.features)}else{var wait=setInterval(function(){if(provinceFS.features&&!isEmptyObject(provinceFS.features)){render(agg["province"],provinceFS.features);clearInterval(wait)}},1000)}function render(provinces,features){var min=Number.MAX_VALUE,max=0;require(["esri/graphic","esri/symbols/TextSymbol","esri/Color","esri/symbols/Font"],function(Graphic,TextSymbol,Color,Font){for(var key in features){if(provinces.hasOwnProperty(key)){var g=features[key];var count=provinces[key];g.attributes.count=count;var newGraphic=new Graphic(g);featureLayer.add(newGraphic);MyFeatureLayer.addLabel(labelLayer,newGraphic,count);setMinMax(count)}}renderFeatureLayer(featureLayer,min,max)});function setMinMax(count){if(count<min){min=count}if(count>max){max=count}}}}function showCityFromArcGis(agg){if(!agg["country@%city"]||isEmptyObject(agg["country@%city"])){return}var countries=agg["country@%city"],cities={};for(var co in countries){var country=countries[co];if(co=="中国"||country.en=="China"){cities=country["cities"];break}}if(isEmptyObject(cities)){return}if(cityLayer.graphics&&cityLayer.graphics.length>0){render(cities,cityLayer.graphics)}else{var count=0;var wait=setInterval(function(){if((cityLayer.graphics&&cityLayer.graphics.length>0)||count>10){render(cities,cityLayer.graphics);clearInterval(wait)}},1000)}function render(cities,features){var min=Number.MAX_VALUE,max=0;for(var key in cities){for(var i=0;i<features.length;i++){if(features[i].attributes["Name_CHN"].indexOf(key)>=0){var count=cities[key];var g=features[i];g.attributes.count=count;featureLayer.add(g);MyFeatureLayer.addLabel(labelLayer,g,count);setMinMax(count);MyFeatureLayer.featuresDisplayed[key]=count}}}renderFeatureLayer(featureLayer,0,max);function setMinMax(count){if(count<min){min=count}if(count>max){max=count}}}}function renderFeatureLayer(layer,min,max){require(["esri/graphic","esri/renderers/SimpleRenderer","esri/Color","esri/symbols/SimpleFillSymbol","esri/symbols/SimpleLineSymbol"],function(Graphic,SimpleRenderer,Color,SimpleFillSymbol,SimpleLineSymbol,Legend){var sfs=new SimpleFillSymbol().setOutline(new SimpleLineSymbol().setWidth(0.1).setColor(new Color([128,128,128])));
    var renderer=new SimpleRenderer(sfs);renderer.setColorInfo({field:"count",minDataValue:min,maxDataValue:max,colors:[new Color([221,200,225,0.75]),new Color([121,37,135,0.7])]});layer.setRenderer(renderer);map.addLayer(layer,3);layer.show();map.addLayer(labelLayer,4)})}},hide:function(){ArcMap.v.featureLayer.clear();ArcMap.v.featureLayer.hide();ArcMap.v.labelLayer.clear();ArcMap.v.labelLayer.hide();$("#featureInfo").hide()},updateCityLayer:function(mapVariables){var cities=MyFeatureLayer.featuresDisplayed,cityLayer=mapVariables.cityLayer,featureLayer=mapVariables.featureLayer;if(cityLayer.graphics&&cityLayer.graphics.length>0){render(cities,cityLayer.graphics)}else{var wait=setInterval(function(){if(cityLayer.graphics&&cityLayer.graphics.length>0){render(cities,cityLayer.graphics);clearInterval(wait)}},1000)}function render(cities,features){var min=Number.MAX_VALUE,max=0;for(var key in cities){for(var i=0;i<features.length;i++){if(features[i].attributes["Name_CHN"].indexOf(key)>=0){var count=cities[key];var g=features[i];g.attributes.count=count;featureLayer.add(g);MyFeatureLayer.addLabel(mapVariables.labelLayer,g,count);setMinMax(count)}}}renderFeatureLayer(featureLayer,0,max);function setMinMax(count){if(count<min){min=count}if(count>max){max=count}}}function renderFeatureLayer(layer,min,max){require(["esri/graphic","esri/renderers/SimpleRenderer","esri/Color","esri/symbols/SimpleFillSymbol","esri/symbols/SimpleLineSymbol"],function(Graphic,SimpleRenderer,Color,SimpleFillSymbol,SimpleLineSymbol,Legend){var sfs=new SimpleFillSymbol().setOutline(new SimpleLineSymbol().setWidth(0.2).setColor(new Color("#000")));var renderer=new SimpleRenderer(sfs);renderer.setColorInfo({field:"count",minDataValue:min,maxDataValue:max,colors:[new Color([221,200,225,0.75]),new Color([121,37,135,0.7])]});layer.setRenderer(renderer);mapVariables.map.addLayer(layer,3);layer.show();mapVariables.map.addLayer(ArcMap.v.labelLayer,4)})}},addLabel:function(layer,graphic,text){require(["esri/graphic","esri/symbols/TextSymbol","esri/Color","esri/symbols/Font"],function(Graphic,TextSymbol,Color,Font){var label=new TextSymbol(text,new Font("12pt",Font.STYLE_ITALIC,Font.VARIANT_NORMAL,Font.WEIGHT_BOLDER,"Courier"),new Color([60,215,60]));layer.add(new Graphic(graphic.geometry,label))})}};var MapSidebar={_WrapperSel:"#mapSidebar",wrapper:$("#mapSidebar"),isHidden:function(){return $(this._WrapperSel).is(":hidden")},show:function(){$(this._WrapperSel).show(500)},hide:function(){$(this._WrapperSel).hide(500)},init:function(data){var devices=data["data"];$(".map-device-list").html("");$.each(devices,function(index,d){addDevices(d)});var total=data["total"],pagesize=data["pagesize"],currpage=data["currpage"];paginator(total,pagesize,currpage);var hoverTimeout;$(".map-device-list li a").on("click",function(e){e.preventDefault();$(this).closest("h3").next().toggleClass("on")}).hover(function(){var $this=$(this).closest("h3").next();hoverTimeout=setTimeout(function(){var lis=$(".map-device-list li div").slideUp("slow");$this.slideDown("slow")},500)},function(){clearTimeout(hoverTimeout)});function addDevices(device){var $li=$('<li id="'+device.ip+'"></li>').appendTo($(".map-device-list"));var $title=$('<h3><a href="#">'+device.ip+"</a></h3>").appendTo($li);$("#mapa").on("click",function(e){e.preventDefault()});var $info=$('<div class="well"></div>').appendTo($li);var loc=device.location,time=device.timestamp,tags=device.tags,ports=device.ports,portsStr="",vuls=device.vuls;$info.append($("<span>位置"+loc+"</span><br>"));if(ports&&ports!=""&ports.length>0){for(var i=0;i<ports.length;i++){for(var key in ports[i]){portsStr+=key+" "}}}$info.append($("<span>服务"+portsStr+"</span><br>"));var vulsStr="";if(vuls&&vuls!=""){for(var key in vuls){vulsStr+=key+" "}}$info.append($("<span>漏洞"+vulsStr+"</span><br>"));$info.append($("<span>标签"+tags.join(" ")+"</span><br>"))}function paginator(totalCounts,pageSize,currentPageNum){$("#map_pager").jqPaginator({totalPages:totalCounts,visiblePages:1,currentPage:currentPageNum,prev:'<li class="prev"><a href="javascript:void(0);"><span class="fa fa-caret-left"></span></a></li>',next:'<li class="next"><a href="javascript:void(0);"><span class="fa fa-caret-right"></a></li>',page:'<li class="page"><a href="javascript:void(0);">{{page}}</a></li>',onPageChange:function(n,type){if(type=="change"){ArcMap.search(n)}}})}},onSelectionChange:function(){var selected=map.infoWindow.getSelectedFeature()}};var paginator=function(totalCounts,pageSize,currentPageNum,visiblePages,onChangeFunc){if(!visiblePages){visiblePages=Constant.VISIBLE_PAGES}if(!pageSize){pageSize=Constant.PAGE_SIZE}if(!totalCounts){totalCounts=0}var $pagerWrapper=$("#pager").show();$pagerWrapper.jqPaginator({totalCounts:totalCounts,pageSize:pageSize,visiblePages:visiblePages,currentPage:currentPageNum,first:'<li class="first"><a href="javascript:void(0);">首页</a></li>',prev:'<li class="prev"><a href="javascript:void(0);"><i class="fa fa-caret-left"></i>上一页</a></li>',next:'<li class="next"><a href="javascript:void(0);">下一页<i class="fa fa-caret-right"></i></a></li>',last:'<li class="last"><a href="javascript:void(0);">末页</a></li>',page:'<li class="page"><a href="javascript:void(0);">{{page}}</a></li>',onPageChange:function(num,type){if(type=="change"){onChangeFunc(num)
}}})};var LoadData={get:function(requestObj){$.ajax({url:requestObj.url,type:"get",dataType:"json",timeout:50000,beforeSend:function(){if(requestObj.beforeSend){requestObj.beforeSend()}}}).success(requestObj.success).error(requestObj.error?requestObj.error:errorHandler()).complete(function(jqXHR,textStatus){})},post:function(requestObj){$.ajax({url:requestObj.url,type:"post",contentType:"application/json",dataType:"json",timeout:50000,data:JSON.stringify(requestObj.data),beforeSend:function(){disableButtons(true);Pace.start()}}).success(requestObj.success).error(function(e){console.log("ajax error");if(requestObj.error){requestObj.error()}else{errorHandler()}}).complete(function(jqXHR,textStatus){disableButtons(false);Pace.stop()})}};var disableButtons=function(disable){var homeSearchBtn=$("#home_search_btn"),globalSearchBtn=$("#global_search_button"),advsBtn=$("#advs_search_btn");var disableButton=function(button,flag){if(button){button.prop("disabled",flag)}};if(disable){disableButton(homeSearchBtn,true);disableButton(globalSearchBtn,true);disableButton(advsBtn,true)}else{disableButton(homeSearchBtn,false);disableButton(globalSearchBtn,false);disableButton(advsBtn,false)}};function isEmptyObject(obj){var flag=true;for(var n in obj){if(obj[n]){flag=false;break}}return flag}Date.prototype.toDateInputValue=(function(){var local=new Date(this);local.setMinutes(this.getMinutes()-this.getTimezoneOffset());return local.toJSON().slice(0,10)});function dateLocalize(timestamp){if(timestamp){return(new Date(parseInt(timestamp))).toLocaleDateString()}return timestamp}function getRootPath(){var strFullPath=window.document.location.href;var strPath=window.document.location.pathname;var pos=strFullPath.indexOf(strPath);var prePath=strFullPath.substring(0,pos);var postPath=strPath.substring(0,strPath.substr(1).indexOf("/")+1);return(prePath+postPath)};